name: Deploy Frontend to VM

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 4.247.29.26 >> ~/.ssh/known_hosts

    - name: Deploy Frontend
      run: |
        ssh seed@4.247.29.26 << 'EOF'
        set -e

        echo "Deploying Frontend..."
        cd /opt/scholarai/ScholarAI-Frontend

        echo "Updating ScholarAI-Frontend..."
        git pull origin main

        echo "Installing Docker Compose if not present..."
        if ! command -v docker-compose &> /dev/null; then
          echo "Docker Compose not found, installing..."
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          echo "Docker Compose installed successfully"
        else
          echo "Docker Compose already installed"
        fi

        echo "Making docker.sh executable..."
        chmod +x ./scripts/docker.sh

        echo "Stopping Frontend..."
        ./scripts/docker.sh stop || true

        echo "ðŸ”¨ Building and starting Frontend..."
        ./scripts/docker.sh build
        ./scripts/docker.sh start

        echo "Frontend deployment completed!"
        EOF

    - name: Health Check
      run: |
        sleep 30
        echo "Running health check for Frontend..."
        if curl -f http://4.247.29.26:3000; then
          echo "Frontend is responding"
        else
          echo "Frontend health check failed"
          exit 1
        fi
